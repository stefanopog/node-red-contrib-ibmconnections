<script type="text/javascript">
/*
Copyright IBM All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
*/
    RED.nodes.registerType(
        'ICCommunitiesGet',
        {
            category: "IBMsocial",
            inputs: 1,
            outputs:1,
            icon: "ibmconnections.png",
            color: "#FFFFFF",
            label: function() {
                    return this.name ||'Get Communities';
                    },
            paletteLabel : "Get Communities",
            defaults : {
                name: {
                            value: ""
                },
                server: {
                            value : "",
                            required: true,
                            type: "ICLogin2"
                },
                target: {
                            value : "AllCommunities",
                            required: true
                },
                communityTag: {
                            value : "",
                            required: false
                },
                searchString: {
                            value : "",
                            required: false
                },
                communityId: {
                            value : "",
                            required: false
                },
                userId: {
                            value : "",
                            required: false
                },
                showMembers: {
                            value : false,
                            required: false
                },
                showApplications: {
                            value : false,
                            required: false
                },
                showLogo: {
                            value : false,
                            required: false
                },
                showWidgets: {
                            value : false,
                            required: false
                }
            },
            oneditprepare: __IC_updateFormCommunitiesGet
        });

        function __IC_communitiesGetOnChange() {
            switch (document.querySelector("#node-input-target").value) {
                case "MyCommunities" :
                    document.querySelector("#searchRow").style.display = "inherit";
                    document.querySelector("#tagRow").style.display = "inherit";
                    document.querySelector("#userRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "none";
                    document.querySelector("#output_options").style.display = "inherit";
                    break;
                case "AllCommunities" :
                    document.querySelector("#searchRow").style.display = "inherit";
                    document.querySelector("#tagRow").style.display = "inherit";
                    document.querySelector("#userRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "none";
                    document.querySelector("#output_options").style.display = "inherit";
                    break;
                case "UserCommunities" :
                    document.querySelector("#searchRow").style.display = "inherit";
                    document.querySelector("#tagRow").style.display = "inherit";
                    document.querySelector("#userRow").style.display = "inherit";
                    document.querySelector("#communityRow").style.display = "none";
                    document.querySelector("#output_options").style.display = "inherit";
                    break;
                case "Members" :
                    document.querySelector("#searchRow").style.display = "none";
                    document.querySelector("#tagRow").style.display = "none";
                    document.querySelector("#userRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "inherit";
                    document.querySelector("#output_options").style.display = "none";
                    break;
                case "Id" :
                    document.querySelector("#searchRow").style.display = "none";
                    document.querySelector("#tagRow").style.display = "none";
                    document.querySelector("#userRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "inherit";
                    document.querySelector("#output_options").style.display = "inherit";
                    break;
            }
       }
    function __IC_updateFormCommunitiesGet() {
        if ((this.showMembers === undefined) || (this.showMembers === null)) {
            this.showMembers = false;
            document.querySelector("#node-input-showMembers").value = false;
            document.querySelector("#node-input-showMembers").checked = false;
        }
        if ((this.showApplications === undefined) || (this.showApplications === null)) {
            this.showApplications = false;
            document.querySelector("#node-input-showApplications").value = false;
            document.querySelector("#node-input-showApplications").checked = false;
        }
        if ((this.showWidgets === undefined) || (this.showWidgets === null)) {
            this.showWidgets = false;
            document.querySelector("#node-input-showWidgets").value = false;
            document.querySelector("#node-input-showWidgets").checked = false;
        }
        if ((this.showLogo === undefined) || (this.showLogo === null)) {
            this.showLogo = false;
            document.querySelector("#node-input-showLogo").value = false;
            document.querySelector("#node-input-showLogo").checked = false;
        }
        var targetInputField = $("#node-input-target")[0];
        targetInputField.addEventListener('change', __IC_communitiesGetOnChange);

        __IC_communitiesGetOnChange();
   }
</script>

<script type="text/x-red" data-template-name="ICCommunitiesGet">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server" placeholder="Server">
    </div>

    <div class="form-row">
        <label for="node-input-target"><i class="fa fa-arrow-circle-right"></i> Target</label>
        <select id="node-input-target">
	       <option value="MyCommunities">My Communities</option>
	       <option value="AllCommunities">All Communities</option>
	       <option value="UserCommunities">User Communities</option>
	       <option value="Members">Community Members</option>
           <option value="Id">Community By Id</option>
        </select>
        <br />
    </div>

    <div class="form-row" id="userRow">
        <label for="node-input-userId"><i class="fa fa-odnoklassniki"></i> User</label>
        <input type="text" id="node-input-userId" placeholder="User ID (ie. toto@myorg.com OR 51689d40-e7ed-102f-87b6-86a3c2278316)"></input>
        <br />
    </div>

    <div class="form-row" id="tagRow">
        <label for="node-input-communityTag"><i class="fa fa-tag"></i> Tag</label>
        <input type="text" id="node-input-communityTag" placeholder="tag"></input>
        <br />
   </div>

    <div class="form-row" id="searchRow">
        <label for="node-input-searchString"><i class="fa fa-tag"></i> Search</label>
        <input type="text" id="node-input-searchString" placeholder="Well formed search string"></input>
        <br />
   </div>

    <div class="form-row" id="communityRow">
        <label for="node-input-communityId"><i class="fa fa-users"></i> Comm. yId</label>
        <input type="text" id="node-input-communityId" placeholder="ID"></input>
        <br />
   </div>

   <br />
   <br />
   
   <div class="form-row" id="output_options">
    <b><legend style="font-size: 14px">Output options</legend></b>

        <div class="form-row">
                <label for="node-input-showMembers" style="width: initial"><i class="fa fa-users" /> Show Members</label>
                <input type="checkbox" name="showMembers" id="node-input-showMembers" style="width: initial" />
        </div>

        <div class="form-row">
                <label for="node-input-showLogo" style="width: initial"><i class="fa fa-image" /> Show Logo</label>
                <input type="checkbox" name="showLogo" id="node-input-showLogo" style="width: initial" />
        </div>

        <div class="form-row">
                <label for="node-input-showApplications" style="width: initial"><i class="fa fa-cubes" /> Show Applications</label>
                <input type="checkbox" name="showApplications" id="node-input-showApplications" style="width: initial" />
        </div>

        <div class="form-row">
                <label for="node-input-showWidgets" style="width: initial"><i class="fa fa-cog" /> Show Widgets</label>
                <input type="checkbox" name="showWidgets" id="node-input-showWidgets" style="width: initial" />
        </div>
    </div>

    <br />

    <div class="form-row">
        <hr />
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</span></label>
        <input type="text" id="node-input-name" ></input>
    </div>

 </script>

<script type="text/x-red" data-help-name="ICCommunitiesGet">
    <p>
        A node that retrieves the details of one or more IBM Connections Communities, based on the following:
        <ul>
            <li><b>All Public Communities</b>, possibly filtered by <i>tag</i> or by a well-formed <i>search string</i>
            </li>
            <li><b>All User's Communities</b>, possibly filtered by <i>tag</i> or by a well-formed <i>search string</i>
                <br />
                It is possible to
                <ul>
                    <li>
                        get <b>My Communities</b> i.e. the Communities for the user whose credentials are used by the node
                    </li>
                    <li>
                        or the Communities of another user whose <i>ID</i> or <i>email address</i> are provided
                    </li>
                </ul>
            </li>
            <li><b>The detailed information</b> for a given Community</li>
            <li><b>The details of all Members</b> of a given Community</li>
        </ul>
    </p>

    <h3>Note</h3>
        If the processing fails or if mandatory inputs are missing, the node terminates with an error. 
        <br />
        The error object is the <strong>incoming msg object</strong> with the additional <code>msg.ICX_fatal</code> attribute which represents the reason for the error. 
        The <code>msg.error</code> output attribute may also be present depending on the processing at the moment of the error.
        <br />
        You may want to catch errors using the <b style="color:red">standard NodeRed CATCH Node</b> as show in the example here below:
        <img src="icons/node-red-contrib-ibmconnections/communityErrorCatching.png" />

    <h3>Inputs</h3>
        <dl class="message-properties">
            <dt class="optional">msg.IC_userId
                <span class="property-type">string</span>
            </dt>
            <dd>
                When you chose the <b>User Communities</b> option in the node's Configuration Panel, then you can set the incoming 
                <code>msg.IC_userId</code> attribute to be either the <code>id</code> or the <code>email address</code> of the user whose Communities you want to retrieve.
                <br />
                The node will automatically understands if an <code>id</code> or an <code>email address</code> are entered. No validation is done on this value until
                the operation is executed.
                <br />
                The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_userId</code> attribute.
            </dd>

            <dt class="optional">msg.IC_communityId
                <span class="property-type">string</span>
            </dt>
            <dd>
                When you chose the <b>Community by Id</b> or the <b>Members</b> options in the node's Configuration Panel, then you can set the incoming 
                <code>msg.IC_communityId</code> attribute to be either the <code>id</code> of the Community you want to retrieve.
                <br />
                The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityId</code> attribute.
            </dd>

            <dt class="optional">msg.IC_communityTag
                <span class="property-type">string</span>
            </dt>
            <dd>
                When you chose the <b>All Communities</b>, the <b>My Communities</b> or the <b>User Communities</b> options in the node's Configuration Panel, then you can set the incoming 
                <code>msg.IC_communityTag</code> attribute to be the value of <b>a single tag</b> that will be used to filter the resuls from the API.
                <br />
                The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityTag</code> attribute.
            </dd>

            <dt class="optional">msg.IC_communitySearch
                <span class="property-type">string</span>
            </dt>
            <dd>
                When you chose the <b>All Communities</b>, the <b>My Communities</b> or the <b>User Communities</b> options in the node's Configuration Panel, then you can set the incoming 
                <code>msg.IC_communitySearch</code> attribute to be <b>a well formed search string</b> that will be used to filter the resuls from the API.
                <br />
                The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communitySearch</code> attribute.
            </dd>

            <dt class="optional">Show Logo
                <span class="property-type">checbox</span>
            </dt>
            <dd>
                You can check the <b>Show Logo</b> in the node's Configuration Panel checkbox to ask the node to retrieve the image corresponding to the Community Logo. 
                <br />
                In this case, a <code>logo</code> attribute will be added to the output message for each retrieved community. You can, the, use code similar 
                to the following one to write the image file on disk:
                <br />
                <code>fs.writeFile('communityImage.jpeg', msg.payload[i].logo, 'binary', function(err){.... </code>
                <br />
                You can only set this property from the <b>node's Configuration Panel</b>.
            </dd>

            <dt class="optional">Show Members
                <span class="property-type">checbox</span>
            </dt>
            <dd>
                You can check the <b>Show Members</b> in the node's Configuration Panel checkbox to ask the node to retrieve the details of all the members of each retrieved Community. 
                <br />
                In this case, a <code>members</code> attribute will be added to the output message for each retrieved community. The structure of the output will look like the following one:
                <br />
                <img src="icons/node-red-contrib-ibmconnections/communityShowMembers.png" />
                <br />
                You can only set this property from the <b>node's Configuration Panel</b>.
            </dd>

            <dt class="optional">Show Widgets
                <span class="property-type">checbox</span>
            </dt>
            <dd>
                You can check the <b>Show Widgets</b> in the node's Configuration Panel checkbox to ask the node to retrieve the details of all the widgets of each retrieved Community. 
                <br />
                In this case, a <code>widgets</code> attribute will be added to the output message for each retrieved community. The structure of the output will look like the following one:
                <br />
                <img src="icons/node-red-contrib-ibmconnections/communityShowWidgets.png" />
                <br />
                You can only set this property from the <b>node's Configuration Panel</b>.
            </dd>

            <dt class="optional">Show Applications
                <span class="property-type">checbox</span>
            </dt>
            <dd>
                You can check the <b>Show Applications</b> in the node's Configuration Panel checkbox to ask the node to retrieve the details of all the Applications of each retrieved Community. 
                <br />
                In this case, a <code>remoteApplications</code> attribute will be added to the output message for each retrieved community. The structure of the output will look like the following one:
                <br />
                <img src="icons/node-red-contrib-ibmconnections/communityShowApplications.png" />
                <br />
                You can only set this property from the <b>node's Configuration Panel</b>.
            </dd>
    
        </dl>

    <h3>Outputs</h3>
        <dl class="message-properties">
            <dt>msg.payload
                <span class="property-type">Object</span>
            </dt>
            <dd>
                When you select <b>Community By ID</b> in the node's Configuration Panel, all the details of the given community are returned as represented here below:
                <br />
                <img src="icons/node-red-contrib-ibmconnections/communityDetails.png" />
                <br />
                Note that the <code>logo</code>, <code>members</code>, <code>widgets</code> and <code>remoteApplications</code> can also be returned as part of this
                output in case you selected the corrsponding checkboxes in the node's Configuration Panel.
                <br />
                If the <code>ICDebug=true</code> environment variable is set, two additional attributes are also returned:
                <ul>
                    <li>
                        <code>entry</code> representing the ATOM result from the IBM Connections API
                    </li>
                    <li>
                        <code>originalentry</code> representing the JSON representation of the ATOM result from the IBM Connections API
                    </li>
                </ul>
            </dd>

            <dt>msg.payload
                <span class="property-type">Array of Objects</span>
            </dt>
            <dd>
                When you select <b>All Communities</b>, the <b>My Communities</b> or the <b>User Communities</b> options in the node's Configuration Panel, all the details of the given communities are returned.
                <br />
                The result is an Array of Objects, where each object has the exact same structure as the output for the <b>Community by ID</b> option described above.
                <br />
                Obviously, the additional attributes described above also apply to each item in the Array.
            </dd>

            <dt>msg.payload
                <span class="property-type">Object</span>
            </dt>
            <dd>
                When you select <b>Community Members</b> in the node's Configuration Panel, all the details for all the members of the given community are returned as represented here below:
                <br />
                <img src="icons/node-red-contrib-ibmconnections/communityMembers.png" />
            </dd>
    
        </dl>
</script>

<script type="text/javascript">
    RED.nodes.registerType(
        'ICCommunitiesUpdate',
        {
            category: "IBMsocial",
            inputs: 1,
            outputs:1,
            icon: "ibmconnections.png",
            color: "#FFFFFF",
            label: function() {
                    return this.name ||'New/Update Communities';
                    },
            paletteLabel : "New/Update Communities",
            defaults : {
                name: {
                    value: ""
                },
                server: {
                    value : "",
                    required: true,
                    type: "ICLogin2"
                },
                newOrUpdate: {
                    value : "Create",
                    required: true
                },
                communityType: {
                    value : "public",
                    required: false
                },
                communityVisibility: {
                    value: "Visible",
                    required: false
                },
                communityExternal: {
                    value: "Internal",
                    required: false
                },
                communityId: {
                    value : "",
                    required: false
                },
                motherCommunityId: {
                    value : "",
                    required: false
                },
                communityTitle: {
                    value : "",
                    required: false
                },
                communityDesc: {
                    value : "",
                    required: false
                },
                communityTags: {
                    value : "",
                    required: false
                },
                replaceTags: {
                    value: false,
                    required: false
                },
                target: {
                    value : "none",
                    required: true
                },
                userId: {
                    value : "",
                    required: false
                },
                userRole: {
                    value : "member",
                    required: false
                },
                target2: {
                    value : "none",
                    required: true
                },
                widgetId: {
                    value : "",
                    required: false
                },
                imageFrom: {
                    value : "none",
                    required: false
                },
                localImage: {
                    value : "",
                    required: false
                },
                internetImage: {
                    value : "",
                    required: false
                },
                localImageBytes: {
                    value : ""
                },
                internetImageBytes: {
                    value : ""
                }
            },
            oneditprepare: __IC_updateFormCommunitiesUpdate
        });

        function __IC_communityTypeValue() {
            switch (document.querySelector("#node-input-communityType").value) {
                case "private" :
                    document.querySelector("#communityRestrictedSelection").style.display = "inherit";
                    break;
                case "publicInviteOnly" :
                    document.querySelector("#communityRestrictedSelection").style.display = "none";
                    break;
                case "public" :
                    document.querySelector("#communityRestrictedSelection").style.display = "none";
                    break;
                case "fromMsg" :
                    document.querySelector("#communityRestrictedSelection").style.display = "none";
                    break;
            }
        }
        function __IC_communityChangeOp() {
            switch (document.querySelector("#node-input-newOrUpdate").value) {
                case "Create" :
                    document.querySelector("#communityCreateOptions").style.display = "inherit";
                    document.querySelector("#subCommunityRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "none";
                    break;
                case "SubCommunity" :
                    document.querySelector("#communityCreateOptions").style.display = "inherit";
                    document.querySelector("#subCommunityRow").style.display = "inherit";
                    document.querySelector("#communityRow").style.display = "none";
                    break;
                case "Update" :
                    document.querySelector("#communityCreateOptions").style.display = "none";
                    document.querySelector("#subCommunityRow").style.display = "none";
                    document.querySelector("#communityRow").style.display = "inherit";
                    break;
            }
            __IC_communityTypeValue();
        }
        function __IC_changeMembersValue() {
            switch (document.querySelector("#node-input-target").value) {
                case "AddMember" :
                    document.querySelector("#userRow").style.display = "inherit";
                    document.querySelector("#userRoleRow").style.display = "inherit";
                    break;
                case "RemoveMember" :
                    document.querySelector("#userRow").style.display = "inherit";
                    document.querySelector("#userRoleRow").style.display = "none";
                    break;
                case "none" :
                case "fromMsg" :
                    document.querySelector("#userRow").style.display = "none";
                    document.querySelector("#userRoleRow").style.display = "none";
                    break;
                }
        }

        function __IC_changeWidgetsValue() {
            switch (document.querySelector("#node-input-target2").value) {
                case "AddWidget" :
                    document.querySelector("#widgetsRow").style.display = "inherit";
                    break;
                case "RemoveWidget" :
                    document.querySelector("#widgetsRow").style.display = "inherit";
                    break;
                case "none" :
                case "fromMsg" :
                    document.querySelector("#widgetsRow").style.display = "none";
                    break;
                }
        }
        function __IC_changeImageFromValue() {
            switch (document.querySelector("#node-input-imageFrom").value) {
                case "none":
                case "fromMsg" :
                    //
                    //  We do not want to change the logo
                    //
                    document.querySelector("#uploadLocalPhoto").style.display = "none";
                    document.querySelector("#uploadInternetPhoto").style.display = "none";
                    document.querySelector("#theImageLocal").style.display = "none";
                    document.querySelector("#theImageInternet").style.display = "none";
                    document.querySelector("#thePreview").style.display = "none";
                    break;
                case "localFile" :
                    document.querySelector("#uploadLocalPhoto").style.display = "inherit";
                    document.querySelector("#uploadInternetPhoto").style.display = "none";
                    document.querySelector("#theImageLocal").style.display = "inherit";
                    document.querySelector("#theImageInternet").style.display = "none";
                    document.querySelector("#thePreview").style.display = "inherit";
                    break;
                case "url" :
                    document.querySelector("#uploadLocalPhoto").style.display = "none";
                    document.querySelector("#uploadInternetPhoto").style.display = "inherit";
                    document.querySelector("#theImageLocal").style.display = "none";
                    document.querySelector("#theImageInternet").style.display = "inherit";
                    document.querySelector("#thePreview").style.display = "inherit";
                    break;
            }
        }
        function __IC_updateFormCommunitiesUpdate() {
            //
            //  Taking care of new parameters
            //
            if (!this.newOrUpdate) {
                this.imageFrom = 'Create';
                document.querySelector("#node-input-newOrUpdate").value = 'Create';
            }
            if (!this.communityType) {
                this.communityType = 'public';
                document.querySelector("#node-input-communityType").value = 'public';
            }
            if (!this.communityVisibility) {
                this.communityVisibility = 'Visible';
                document.querySelector("#node-input-communityVisibility").value = 'Visible';
            }
            if (!this.communityExternal) {
                this.communityExternal = 'Internal';
                document.querySelector("#node-input-communityExternal").value = 'Internal';
            }
            if (!this.imageFrom) {
                this.imageFrom = 'none';
                document.querySelector("#node-input-imageFrom").value = 'none';
            }
            if (!this.target2) {
                this.target2 = 'none';
                document.querySelector("#node-input-target2").value = 'none';
            }
            if ((this.replaceTags === undefined) || (this.replaceTags === null)) {
                this.replaceTags = false;
                document.querySelector("#node-input-replaceTags").value = false;
                document.querySelector("#node-input-replaceTags").checked = false;
            }
            //
            //  Preloading visualization if present
            //
            if (this.localImageBytes) {
                document.querySelector("#theImageLocal").src = this.localImageBytes;
                document.querySelector("#theImageLocal").style.display = "inherit";
            }
            if (this.localImage && (this.localImage !== '')) {
                document.querySelector('#labelImageLocal').innerText += ' (' + this.localImage + ')';
            }
            if (this.internetImageBytes) {
                document.querySelector("#theImageInternet").src = this.internetImageBytes;
                document.querySelector("#theImageInternet").style.display = "inherit";
            }

            //
            //  Set the process to capture the INPUT FILE result
            //
            var fileInputField = $("#localInputFile")[0];
            //fileInputField.style.opacity = 0;
            fileInputField.addEventListener('change', __IC_updateLocalImageDisplay);

            var internetInputField = $("#node-input-internetImage")[0];
            internetInputField.addEventListener('change', __IC_updateInternetImageDisplay);

            var targetInputField = $("#node-input-target")[0];
            targetInputField.addEventListener('change', __IC_changeMembersValue);

            var target2InputField = $("#node-input-target2")[0];
            target2InputField.addEventListener('change', __IC_changeWidgetsValue);

            var imageFromInputField = $("#node-input-imageFrom")[0];
            imageFromInputField.addEventListener('change', __IC_changeImageFromValue);

            var newOrUpdateField = $("#node-input-newOrUpdate")[0];
            newOrUpdateField.addEventListener('change', __IC_communityChangeOp);

            var communityTypeField = $("#node-input-communityType")[0];
            communityTypeField.addEventListener('change', __IC_communityTypeValue);

            //
            //  Initial Visual Setup
            //
            __IC_communityChangeOp();
            __IC_changeMembersValue();
            __IC_changeWidgetsValue();
            __IC_changeImageFromValue();
        }

        function __IC_updateLocalImageDisplay() {
            //
            //  Local functions
            //
            function __IC_validFileType(file) {
                var fileTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                for(let i = 0; i < fileTypes.length; i++) {
                    if (file.type === fileTypes[i]) {
                        return true;
                    }
                }
                return false;
            }
            function __IC_returnFileSize(number) {
                if(number < 1024) {
                    return number + ' octets';
                } else if(number >= 1024 && number < 1048576) {
                    return (number/1024).toFixed(1) + ' Ko';
                } else if(number >= 1048576) {
                    return (number/1048576).toFixed(1) + ' Mo';
                }
            } 
            var thePreview = $("#thePreview")[0];
            var image = $("#theImageLocal")[0];
            var label = $('#labelImageLocal')[0];
            var otherImage = $("#theImageInternet")[0];
            var para = $("#theP")[0];
            var fileInputField = $("#localInputFile")[0];
            var curFiles = fileInputField.files;
            if(curFiles.length === 0) {
                para.textContent = 'No files currently selected for upload';
                para.style.display = "inherit";
                image.style.display = "none";
                otherImage.style.display = "none";
            } else {
                if (__IC_validFileType(curFiles[0])) {
                    //para.textContent = 'File name ' + curFiles[0].name + ', file size ' + __IC_returnFileSize(curFiles[0].size) + '.';
                    image.style.display = "inherit";
                    otherImage.style.display = "none";
                    para.style.display = "none";

                    let reader = new FileReader();
                    reader.onload = (function(theFile) {
                        return function(e) {
                            //
                            //  visual of the image
                            //
                            image.src = reader.result;
                            //
                            //  Node variable containing the file name
                            //
                            $('#node-input-localImage')[0].value = curFiles[0].name;
                            //
                            //  Node Variable containing the blob
                            //
                            $("#node-input-localImageBytes")[0].value = reader.result;
                            //
                            //  Changing the value of the clickable label to reflect the name of the file
                            //
                            let rr = /(\(.+?\))/;
                            if (label.innerText.match(rr)) {
                                label.innerText = label.innerText.replace(rr, '(' + curFiles[0].name + ')');
                            } else {
                                label.innerText += ' (' + curFiles[0].name + ')';
                            }
                        };
                    })(curFiles[0]);
                    //
                    //  Read in the image file as a data URL.
                    //
                    reader.readAsDataURL(curFiles[0]);
                } else {
                    para.style.display = "inherit";
                    para.textContent = 'File name ' + curFiles[0].name + ': Not a valid file type. Update your selection.';
                    image.style.display = "none";
                    otherImage.style.display = "none";
                }
            }
        }
        function __IC_updateInternetImageDisplay() {
            var theFile = $('#node-input-internetImage')[0].value;
            if (theFile === '') return;
            var para = $("#theP")[0];
            var image = $("#theImageInternet")[0];
            var otherImage = $("#theImageLocal")[0];

            let options = {
                method: 'GET',
                url: "image?link=" + theFile, 
                beforeSend: function (xhr) {
                    xhr.overrideMimeType('text/plain; charset=x-user-defined');
                }
            };

            $.ajax(options)
            .done((data, textStatus, xhr) => {
                image.src = data;
                image.style.display = "inherit";
                $("#node-input-internetImageBytes")[0].value = image.src;
                otherImage.style.display = "none";
                para.style.display = "none";
            }).fail(( xhr, textStatus, error ) => {
                para.style.display = "inherit";
                para.textContent = 'Image ' + theFile + ' : Not retrieved: ' + xhr.status + ' (' + xhr.statusText + ')';
                image.style.display = "none";
                otherImage.style.display = "none";
                console.log("xhr: " + JSON.stringify(xhr, ' ', 2));
                console.log("textStatus: " + textStatus);
                console.log("error: " + JSON.stringify(error, ' ', 2));
                console.log("status: " + xhr.status + ' (' + xhr.statusText + ')');
                console.log(JSON.stringify(JSON.parse(xhr.responseText), ' ', 2));
            });
        }
</script>

<script type="text/x-red" data-template-name="ICCommunitiesUpdate">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server" placeholder="Server">
    </div>
    
    <div class="form-row">
        <label for="node-input-newOrUpdate"><i class="fa fa-briefcase"></i> Operation</label>
        <select id="node-input-newOrUpdate">
            <option value="Create">Create Community</option>
            <option value="SubCommunity">Create SUBCommunity</option>
            <option value="Update">Update Community</option>
        </select>
        <br />
    </div>

    <div id="communityCreateOptions">
        <div class="form-row" id="communityTypeSelection">
            <label for="node-input-communityType"><i class="fa fa-key"></i> Type</label>
            <select id="node-input-communityType">
                <option value="private">Restricted</option>
                <option value="publicInviteOnly">Moderated</option>
                <option value="public">Public</option>
                <option value="fromMsg">--set from msg.IC_communityType--</option>
            </select>
            <br />
        </div>

        <div class="form-row" id="communityRestrictedSelection">
            <div class="form-row" id="communityVisibility">
                <label for="node-input-communityVisibility"><i class="fa fa-low-vision"></i> Visibility</label>
                <select id="node-input-communityVisibility">
                    <option value="Invisible">Not Visible in List</option>
                    <option value="Visible">Visible in List</option>
                    <option value="fromMsg">--set from msg.IC_communityVisibility--</option>
                </select>
                <br />
            </div>
            <div class="form-row" id="communityExternal">
                <label for="node-input-communityExternal"><i class="fa fa-low-vision"></i> External</label>
                <select id="node-input-communityExternal">
                    <option value="External">Open to External</option>
                    <option value="Internal">Organization Only</option>
                    <option value="fromMsg">--set from msg.IC_communityExternal--</option>
                </select>
                <br />
            </div>
        </div>
        
        <div class="form-row" id="subCommunityRow">
            <label for="node-input-motherCommunityId"><i class="fa fa-users"></i> Comm. Id</label>
            <input type="text" id="node-input-motherCommunityId" placeholder="ID of the mother Community"></input>
            <br />
        </div>
    </div>
        
    <div class="form-row" id="communityRow">
        <label for="node-input-communityId"><i class="fa fa-users"></i> Comm. Id</label>
        <input type="text" id="node-input-communityId" placeholder="ID of the Community to be modified"></input>
        <br />
    </div>

    <div class="form-row" id="communityTitle">
        <label for="node-input-communityTitle"><i class="fa fa-graduation-cap"></i> Title</label>
        <input type="text" id="node-input-communityTitle" placeholder="Community Title"></input>
        <br />
    </div>

    <div class="form-row" id="communityDesc">
        <label for="node-input-communityDesc"><i class="fa fa-list-alt"></i> Description</label>
        <input type="text" id="node-input-communityDesc" placeholder="Community Description"></input>
        <br />
    </div>

    <div class="form-row" id="communityTags">
        <label for="node-input-communityTags"><i class="fa fa-tags"></i> Tags</label>
        <input type="text" id="node-input-communityTags" placeholder="comma-separated list of tags" style="width:60%"/>
        <div style="float: right">
            <label for="node-input-replaceTags" style="width: initial"> Replace</label>
            <input type="checkbox" name="replaceTags" id="node-input-replaceTags" style="width: initial" />
        </div>
    <br />
    </div>
    
    <div class="form-row">
        <label for="node-input-target"><i class="fa fa-address-card"></i> Member Mgmt</label>
        <select id="node-input-target">
            <option value="none">No Member Management</option>
            <option value="AddMember">Add Members</option>
            <option value="RemoveMember">Remove Members</option>
	        <option value="fromMsg">--set from msg.IC_communityMembers--</option>
        </select>
        <br />
    </div>
                            
    <div class="form-row" id="userRow">
        <label for="node-input-userId"><i class="fa fa-users"></i> Users</label>
        <input type="text" id="node-input-userId" placeholder="comma-separated list of IDs or mail addresses"></input>
        <br />
    </div>

    <div class="form-row" id="userRoleRow">
        <label for="node-input-userRole"><i class="fa fa-address-book"></i> Role</label>
        <select id="node-input-userRole">
	       <option value="member">Member</option>
	       <option value="owner">Owner</option>
	       <option value="business-owner">Business Owner</option>
        </select>
        <br />
    </div>

    <div class="form-row">
        <label for="node-input-target2"><i class="fa fa-tachometer"></i> Widget Mgmt</label>
        <select id="node-input-target2">
            <option value="none">No Widgets Management</option>
            <option value="AddWidget">Add Widgets</option>
            <option value="RemoveWidget">Remove Widgets</option>
            <option value="fromMsg">--set from msg.IC_communityWidgets--</option>
        </select>
        <br />
    </div>
                            
    <div class="form-row" id="widgetsRow">
        <label for="node-input-widgetId"><i class="fa fa-cog"></i> Widgets</label>
        <input type="text" id="node-input-widgetId" placeholder="Widgets"></input>
        <br />
    </div>

   <div class="form-row" id="imageSelector">
        <label for="node-input-imageFrom"><i class="fa fa-camera"></i> Logo</label>
        <select id="node-input-imageFrom">
            <option value="none">no logo</option>
            <option value="localFile">from Local File</option>
            <option value="url">from URL</option>
	        <option value="fromMsg">--set from msg.IC_logoFrom--</option>
        </select>
        <br />
    </div>
    
    <div class="form-row" id="uploadLocalPhoto">
        <label id="labelImageLocal" for="localInputFile" title="Load Community Logo" style="width:80%"><i class="fa fa-camera"></i> Click to upload local Image</label>
        <input type="file" id="localInputFile" accept=".jpg, .jpeg, .png"  style="display: none" />
        <br />
    </div>

    <div class="form-row" id="uploadInternetPhoto">
        <label for="node-input-internetImage" title="Load Community Logo"><i class="fa fa-camera"></i> Logo URL</label>
        <input type="text" id="node-input-internetImage" />
        <br />
    </div>
            
    <div class="form-row" id="thePreview">
        <label for="theImageLocal"><i class="fa fa-camera-retro"></i> Preview</label>
        <img id="theImageLocal" style="display:none; width: 110px; height: 110px: object-fit: contain; vertical-align: middle; border-radius: 75%" />
        <img id="theImageInternet" style="display:none; width: 110px; height: 110px: object-fit: contain; vertical-align: middle; border-radius: 75%" />
        <p id="theP" style="display:none; width: 70%; vertical-align: middle" />
        <br />
    </div>

    <div class="form-row" id="node-config-input-upload-file-status-success" style="color:green; display:none;">
        <small class="form-text text-muted">
            <span>Photo has been successfully retrieved.</span>
        </small>
    </div>
    <div class="form-row" id="node-config-input-upload-file-status-failure" style="color:red; display:none;">
        <small class="form-text text-muted">
            <span>The request could not be processed. Please check the Debug Tab for further information!</span>
        </small>
    </div>

    <input type="hidden" id="node-input-localImageBytes" />
    <input type="hidden" id="node-input-localImage" />
    <input type="hidden" id="node-input-internetImageBytes" />

    <br />

    <div class="form-row">
        <hr />
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</span></label>
        <input type="text" id="node-input-name" ></input>
    </div>

 </script>

<script type="text/x-red" data-help-name="ICCommunitiesUpdate">
    <p>
        A node that allows you to either <b style="color:red">Create</b> a new IBM Connections Community (either main Community or SubCommunity) or to <b style="color:red">Update</b> an existing one. 
        <br />
        The following functionalities are available in both cases (<i>Create</i> or <i>Update</i>):
        <ul>
            <li>
                Set the <b>Title</b> and the <b>Description</b> of the Community
            </li>
            <li>
                Set the <b>Tags</b> associated to the Commmunity
            </li>
            <li>
                Set or modify the <b>list of Members</b> of the Community
            </li>
            <li>
                Set or modify the <b>logo</b> of the Community
            </li>
            <li>
                Set or modify <b>the list of Widgets</b> associated to the Community
            </li>
        </ul>
    </p>



    <h3>Note</h3>
        If the processing fails or if mandatory inputs are missing, the node terminates with an error. 
        <br />
        The error object is the <strong>incoming msg object</strong> with the additional <code>msg.ICX_fatal</code> attribute which represents the reason for the error. 
        The <code>msg.error</code> output attribute may also be present depending on the processing at the moment of the error.
        <br />
        You may want to catch errors using the <b style="color:red">standard NodeRed CATCH Node</b> as show in the example here below:
        <img src="icons/node-red-contrib-ibmconnections/communityErrorCatching.png" />

        <h3>Inputs</h3>
            <dl class="message-properties">
                <dt class="optional">Operation
                    <span class="property-type">enumerated</span>
                </dt>
                <dd>
                    This node allows you to <b style="color:red">Create a new Community</b>, <b style="color:red">Create a SubCommunity</b> or <b style="color:red">Update</b> an existing Community.
                    <br />
                    The additional inputs may apply only to one of the above mentioned operations.
                </dd>
    
                <dt class="optional">msg.IC_communityType
                    <span class="property-type">enumerated</span>
                </dt>
                <dd>
                    In case you want to <b>Create a New Community</b> or <b>Create a Subcommuity</b>, you need to specify which type of Community to create.
                    This attribute allows you to choose among the following values: <code>private</code>, <code>public</code> and <code>publicInviteOnly</code> (which corresponds to a <i>Moderated</i> Community).
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityType</code> attribute.
                </dd>
    
                <dt class="optional">msg.IC_communityVisibility
                    <span class="property-type">enumerated</span>
                </dt>
                <dd>
                    In case you choose to <b>Create a New </b><b style="color:red">restricted</b><b> Community or Subcommunity</b>, you need to specify if that Community
                    should be visible when Listing from non members. This enumerated attribute allows you to choose between the <code>Visible</code> or <code>Invisible</code> 
                    values.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityVisibility</code> attribute.
                </dd>
    
                <dt class="optional">msg.IC_communityExternal
                    <span class="property-type">enumerated</span>
                </dt>
                <dd>
                    In case you choose to <b>Create a New </b><b style="color:red">restricted</b><b> Community or Subcommunity</b>, you need to specify if that Community
                    should be open to External Members. This enumerated attribute allows you to choose between the <code>External</code> or <code>Internal</code> 
                    values.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityExternal</code> attribute.
                </dd>

                <dt class="optional">msg.IC_motherCommunityId
                    <span class="property-type">string</span>
                </dt>
                <dd>
                    In case you choose to <b style="color:red">Create a Subcommunity</b>, you need to specify which is the ID of the mother Community for which this 
                    SubCommunity will be created.
                    values.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_motherCommunityId</code> attribute.
                </dd>

                <dt class="optional">msg.IC_communityId
                    <span class="property-type">string</span>
                </dt>
                <dd>
                    In case you choose to <b style="color:red">Update an existing Community</b>, you need to specify which is the ID of the Community to be updated.
                     <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityId</code> attribute.
                </dd>
                    
                <dt class="optional">msg.IC_communityTitle
                        <span class="property-type">string</span>
                </dt>
                <dd>
                    You can specify a Community Title for any operation (Create or Update).
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityTitle</code> attribute.
                </dd>

                <dt class="optional">msg.IC_communityDesc
                        <span class="property-type">string</span>
                </dt>
                <dd>
                    You can specify a Community Description for any operation (Create or Update). 
                    <br />
                    This node supports  entering an <i style="color:red">HTML string</i> for the Description.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityDesc</code> attribute.
                </dd>
                    
                <dt class="optional">msg.IC_communityTags
                        <span class="property-type">comma-separated string</span>
                </dt>
                <dd>
                    You can specify a list of Tags to be assigned to the Community to create or to Update. The tags are specified as a comma-separated list of values. By default 
                    the Tags are added to any other existing Tag for the Community.
                    <br />
                    When using the <code>msg.msg.IC_communityTags</code> attribute to specify the Tags, you can enclose the comma-separated string in normal parentheses (<code>( )</code>.) 
                    in this case the specified list of Tags will replace any other existing Tag assigned to the Community.
                    <br />
                    This same behavior, on the node's Configuration Panel, is achieved by checking the <b>Replace</b> checkbox.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityTitle</code> attribute.
                </dd>

                <dt class="optional">Replace
                    <span class="property-type">checbox</span>
                </dt>
                <dd>
                    When specifying Tags using the node's Configuration Panel, you can force the node to replace any existing Tag with the list of tags specified
                    on the Configuration Panel by checking this checkbox. 
                    <br />
                    You can only set this property from the <b>node's Configuration Panel</b>.
                </dd>
    
                <dt class="optional">IC_communityMembers
                    <span class="property-type">Array of Objects</span>
                </dt>
                <dd>
                    You can <b style="color:red">Add</b> or  <b style="color:red">Remove</b> one or more users as members of the Community. You can do this in two ways:
                    <ul>
                        <li>
                            Using the node's Configuration Panel. <br />
                            In this case, once you select the <code>Add Member</code> option from the dropdown, you will be able to enter a <b>comma-separated string</b> of users, specified
                            either as <b>ID</b> or as <b>email address</b> (the node will be able to understand both). <br />
                            You will also be able to chose the role to be assigned to all the users specified by the comma-separated string. <br />
                            In case you choose the <code>Remove Member</code> option from the dropdown, you will only be allowed to specify the comma-separated list of users to be removed, as <i>Role</i>
                            would not have any influence.
                        </li>
                        <li>
                            Using the <code>msg.IC_communityMembers</code> array attribute.<br />
                            This approach is more flexible in the sense that it allows you to specify for <b>each</b> user to be added which role to apply. The format of the array
                            is similar to the one shown below:
                            <img src="icons/node-red-contrib-ibmconnections/communityAddMembers.png" />
                        </li>
                    </ul>
                    When adding a Member, if the user is already a member of the community with that role, a WARNING will be generated.
                    <br />
                    Likewise, when removing a user who is not Membr of a Community, a WARNING will be generated.
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityMembers</code> attribute.
                </dd>
    
                <dt class="optional">IC_communityWidgets
                    <span class="property-type">Array of Objects</span>
                </dt>
                <dd>
                    You can <b style="color:red">Add</b> or <b style="color:red">Remove</b> one or more Widgets to/from a Community. You can do this in two ways:
                    <ul>
                        <li>
                            Using the node's Configuration Panel. <br />
                            In this case, once you select the <code>Add Widget</code> option from the dropdown, you will be able to enter a <b>comma-separated string</b> of widgets, specified
                            by their <i>widgetDefId</i> . 
                        </li>
                        <li>
                            Using the <code>msg.IC_communityWidgets</code> array attribute.<br />
                            This approach is more flexible in the sense that it allows you to specify for <b>each</b> Widget to be added :
                            <ul>
                                <li>
                                    which action to perform (<b>AddWidget</b> or <b>RemoveWidget</b>): using the <code>.action</code> attribute
                                </li>
                                <li>
                                    which location to use when Adding that Widget (<b>col1</b>, <b>col2</b> or <b>col3</b>): using the <code>.location</code> attribute
                                </li>
                                <li>
                                    Which title to provide when Adding the Widget: using the <code>.title</code> attribute
                                </li>
                                <li>
                                    Which instance to Remove in case of Widgets having multiple instances (suc as the <i>Rich Content</i> widget): using the <code>.id</code> attribute
                                </li>
                            </ul>
                            The format of the array is similar to the one shown below:
                            <img src="icons/node-red-contrib-ibmconnections/communityAddWidgets.png" />
                        </li>
                    </ul>
                    When adding a Widget whose type only allows one instance and which is already present in the Community, a WARNING will be generated.
                    <br />
                    If you  <b>do NOT specify</b> the instance Id of the Widget to be Removed and this Widget has multiple occurrences in the Community, all the instances will be removed.
                    <br />
                    The list of Widgets that can be added/removed is the following (case-sensitive): <i>ImportantBookmarks, StatusUpdates, description, Files, Tags, 
                        RichContent, Wiki, Forum, Bookmarks, Blog, IdeationBlog, Gallery, Calendar, RichContent, FeaturedSurvey, Surveys, MembersSummary, Activities, SubcommunityNav, RelatedCommunities, Connections Engagement Center</i>
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_communityWidgets</code> attribute.
                </dd>
        
                <dt class="optional">msg.IC_logoFrom
                    <span class="property-type">string</span>
                </dt>
                <dd>
                    You can upload a <b>logo image</b> for your Community. You can do this in two ways:
                    <ul>
                        <li>
                            Using the node's Configuration Panel.<br />
                            You can either chose to import an image from the local computer running your NodeRed editor or to provide an URL for an image available on your intranet or on the internet.
                            <br />
                            The image content, in both cases, is automatically loaded and saved as part of the node instance. In this way, it will be available to any other instances of the NodeRed editor (running on different computers, for instance)
                            but, also, from the server where NodeRed will be executing.
                            <br />
                            The image content for a local file or for a URL will be saved separately, thus allowing you to change mind at any time.
                            <br />
                            You can change the local image by clicking on the icon or you can change the URL image by updating the input text box and tabbing out of it.
                        </li>
                        <li>
                            Using the <code>msg.IC_logoFrom</code> attribute. <br />
                            In this case the input attribute can either contain a string representing an image file as an absolute filepath for the server running NodeRed, or 
                            it can contain the URL of an image file available on the intranet or the internet. <br />
                            In this case the server will be in charge of loading the image content as it will process the instance of the node.
                        </li>
                    </ul>
                    <br />
                    The value from the <b>node's Configuration Panel</b> takes precedence on the <code>msg.IC_logoFrom</code> attribute.
               </dd>
            </dl>
    
        <h3>Outputs</h3>
            <dl class="message-properties">
                <dt>msg.payload
                    <span class="property-type">Object</span>
                </dt>
                <dd>
                    The basic output of the Create or Update operation is very similar to the output of the <b style="color:red">Get Commmunities</b> node when the 
                    <b>Get Community by ID</b> is chosen.
                    <br />
                    <img src="icons/node-red-contrib-ibmconnections/communityDetails.png" />
                    <br />
                    <b>Note:</b><br />
                    If the Logo will be added/updated, if members will be added/removed and if widgets will be added/removed, the output will provide information about the changed 
                    properties of the Community. In the picture below, I updated the logo, the members and the widgets of a Community: chek the <code>.logo, .members, .widgets and .remoteApplications</code> attributes of the output:
                    <img src="icons/node-red-contrib-ibmconnections/communityUpdateFullOutput.png" />
                </dd>      
            </dl>
    
        <h3>Warnings</h3>
            <dl class="message-properties">
                <dt>Warnings
                    <span class="property-type">information</span>
                </dt>
                <dd>
                    Here is an example of the warnings that can be raised during the processing of an <b>Update</b> operations.
                    <img src="icons/node-red-contrib-ibmconnections/communityUpdateWarnings.png" />
                </dd>       
            </dl>
 
</script>
